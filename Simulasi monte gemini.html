<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulasi Monte Carlo: Proyeksi Inventaris Bulanan (per Tipe Box)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Simulasi Monte Carlo Proyeksi Bulanan</h1>
            <p class="mt-2 text-lg text-gray-600">Analisis Kebutuhan & Inventaris Returnable Box per Tipe</p>
        </header>

        <!-- Configuration Section -->
        <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-md border border-gray-200 mb-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left Side: Customer Data Input -->
                <div>
                    <label for="customer-data" class="block text-sm font-medium text-gray-700 mb-1">Data Pengiriman per Pelanggan</label>
                    <p class="text-xs text-gray-500 mb-2">Gunakan format: Nama, Frekuensi, Rata-rata Box/Kirim, Tipe Box</p>
                    <textarea id="customer-data" rows="10" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">Customer_1, 19, 130, A
Customer_2, 8, 9, A
Customer_3, 22, 9, D
Customer_4, 4, 13, A
Customer_5, 14, 10, A
Customer_6, 20, 14, A
Customer_7, 9, 1, B
Customer_8, 8, 2, B
Customer_9, 18, 1, A
Customer_10, 15, 16, A
Customer_10, 15, 13, D
Customer_11, 15, 4, A
Customer_12, 19, 46, C
Customer_13, 20, 3, A
Customer_14, 7, 4, A
Customer_15, 18, 14, A
Customer_16, 13, 21, A
Customer_16, 14, 10, B
Customer_17, 13, 3, A
Customer_17, 16, 6, B
Customer_17, 14, 17, C
Customer_18, 20, 5, B
Customer_19, 18, 8, A
Customer_20, 1, 10, A
Customer_21, 0, 0, A
Customer_22, 0, 0, A
Customer_23, 20, 35, A
Customer_23, 10, 8, B
Customer_24, 9, 2, B</textarea>
                </div>
                <!-- Right Side: Simulation Parameters -->
                <div>
                    <div>
                        <label for="simulations" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Skenario Simulasi</label>
                        <input type="number" id="simulations" value="1000" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="mt-4">
                        <label for="simulation-days" class="block text-sm font-medium text-gray-700 mb-1">Periode Simulasi (Hari Kerja)</label>
                        <input type="number" id="simulation-days" value="27" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                     <div class="mt-4">
                        <label for="volatility" class="block text-sm font-medium text-gray-700 mb-1">Volatilitas Box/Kirim (%)</label>
                        <input type="number" id="volatility" value="20" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
            </div>
            <button id="run-simulation" class="w-full mt-6 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">
                Jalankan Simulasi
            </button>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden">
            <h2 class="text-2xl font-bold text-center mb-2">Hasil Agregat Simulasi</h2>
            <p id="total-deliveries-info" class="text-center text-gray-600 mb-6"></p>
            
            <!-- Statistics Cards -->
            <h3 class="font-bold text-xl mb-4 text-center text-gray-700">Analisis Box per Tipe</h3>
            <div id="summary-stats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-8 text-center">
                <!-- Stats will be populated by JS -->
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h3 class="font-bold text-xl mb-4 text-center text-gray-700">Distribusi Total Box Terkirim (Semua Tipe)</h3>
                     <div class="chart-container">
                        <canvas id="total-sent-chart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h3 class="font-bold text-xl mb-4 text-center text-gray-700">Distribusi Box Belum Kembali (Semua Tipe)</h3>
                    <div class="chart-container">
                        <canvas id="outstanding-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Detailed Results Table -->
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                 <h3 class="font-bold text-xl mb-4 text-gray-700">Contoh Hasil per Skenario (100 pertama)</h3>
                 <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Skenario</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Terkirim (A)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Terkirim (B)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Terkirim (C)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Terkirim (D)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Belum Kembali (A)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Belum Kembali (B)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Belum Kembali (C)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Belum Kembali (D)</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body" class="bg-white divide-y divide-gray-200">
                           <!-- Data akan dimasukkan oleh JavaScript -->
                        </tbody>
                    </table>
                 </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA DISTRIBUSI PROBABILITAS ---
        const cycleTimeDist = [
           { value: 0, cumulative: 0.241 }, { value: 1, cumulative: 0.482 }, { value: 2, cumulative: 0.689 },
            { value: 3, cumulative: 0.723 }, { value: 4, cumulative: 0.861 }, { value: 5, cumulative: 0.930 },
            { value: 7, cumulative: 1.000 }
        ];

        let totalSentChartInstance = null;
        let outstandingChartInstance = null;

        // --- FUNGSI BANTUAN ---
        function getValueFromDist(randomNumber, distribution) {
            for (const item of distribution) {
                if (randomNumber <= item.cumulative) return item.value;
            }
            return distribution[distribution.length - 1].value;
        }

        function getNormalDistValue(mean, stdDev) {
            let u1 = 0, u2 = 0;
            while (u1 === 0) u1 = Math.random();
            while (u2 === 0) u2 = Math.random();
            const z0 = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
            return z0 * stdDev + mean;
        }
        
        function parseCustomerData(text) {
            const lines = text.trim().split('\n');
            const customerPlan = [];
            let totalFrequency = 0;
            for (const line of lines) {
                const parts = line.split(',').map(p => p.trim());
                if (parts.length === 4) {
                    const name = parts[0];
                    const frequency = parseInt(parts[1]);
                    const avgBox = parseInt(parts[2]);
                    const boxType = parts[3].toUpperCase();

                    if (!isNaN(frequency) && !isNaN(avgBox) && ['A', 'B', 'C', 'D'].includes(boxType)) {
                        customerPlan.push({ name, frequency, avgBox, boxType });
                        totalFrequency += frequency;
                    }
                }
            }
            return { customerPlan, totalFrequency };
        }

        // --- LOGIKA UTAMA SIMULASI ---
        document.getElementById('run-simulation').addEventListener('click', () => {
            const numSimulations = parseInt(document.getElementById('simulations').value) || 1000;
            const simulationDays = parseInt(document.getElementById('simulation-days').value) || 27;
            const customerDataText = document.getElementById('customer-data').value;
            const { customerPlan, totalFrequency } = parseCustomerData(customerDataText);
            const volatility = parseInt(document.getElementById('volatility').value) / 100 || 0.2;
            
            document.getElementById('total-deliveries-info').textContent = `Berdasarkan total ${totalFrequency} pengiriman dari ${customerPlan.length} baris data pelanggan.`;
            
            let periodResults = [];

            for (let i = 0; i < numSimulations; i++) {
                // Satu periode simulasi
                let sentBoxes = { total: 0, A: 0, B: 0, C: 0, D: 0 };
                let outstandingBoxes = { total: 0, A: 0, B: 0, C: 0, D: 0 };
                
                // Iterasi melalui setiap pelanggan dalam rencana
                for (const customer of customerPlan) {
                    // Simulasikan setiap pengiriman untuk pelanggan ini
                    for (let j = 0; j < customer.frequency; j++) {
                        const deliveryDay = Math.floor(Math.random() * simulationDays);
                        
                        // Gunakan Tipe Box spesifik dari data pelanggan
                        const finalJenisBox = customer.boxType;
                        
                        // Gunakan rata-rata box spesifik pelanggan sebagai dasar
                        const baseBoxKirim = customer.avgBox;
                        const stdDev = baseBoxKirim * volatility;
                        const finalBoxKirim = Math.max(0, Math.round(getNormalDistValue(baseBoxKirim, stdDev)));
                        
                        const finalCycleTime = getValueFromDist(Math.random(), cycleTimeDist);
                        
                        // Catat box yang terkirim
                        sentBoxes.total += finalBoxKirim;
                        sentBoxes[finalJenisBox] += finalBoxKirim;

                        // Cek apakah box sudah kembali pada akhir periode
                        const returnDay = deliveryDay + finalCycleTime;
                        if (returnDay >= simulationDays) {
                            outstandingBoxes.total += finalBoxKirim;
                            outstandingBoxes[finalJenisBox] += finalBoxKirim;
                        }
                    }
                }

                periodResults.push({ 
                    id: i + 1,
                    sent: sentBoxes, 
                    outstanding: outstandingBoxes
                });
            }

            displayResults(periodResults);
        });

        // --- FUNGSI UNTUK MENAMPILKAN HASIL ---
        function displayResults(periodResults) {
            document.getElementById('results-section').classList.remove('hidden');
            
            displaySummaryStats(periodResults);

            const tableBody = document.getElementById('results-table-body');
            tableBody.innerHTML = '';
            periodResults.slice(0, 100).forEach(res => {
                const row = `<tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${res.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${res.sent.A}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${res.sent.B}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${res.sent.C}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${res.sent.D}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-red-700">${res.outstanding.A}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-red-700">${res.outstanding.B}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-red-700">${res.outstanding.C}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-red-700">${res.outstanding.D}</td>
                </tr>`;
                tableBody.innerHTML += row;
            });
            
            createOrUpdateChart('total-sent-chart', 'totalSentChartInstance', 'Total Box Terkirim', periodResults.map(r => r.sent.total));
            createOrUpdateChart('outstanding-chart', 'outstandingChartInstance', 'Box Belum Kembali', periodResults.map(r => r.outstanding.total));
        }

        function displaySummaryStats(results) {
            const getStats = (dataKey, typeKey) => {
                const data = results.map(r => r[dataKey][typeKey]);
                const sum = data.reduce((a, b) => a + b, 0);
                const avg = sum / data.length;
                const max = Math.max(...data);
                return { avg, max };
            };
            
            const types = ['A', 'B', 'C', 'D'];
            const container = document.getElementById('summary-stats');
            container.innerHTML = ''; // Clear previous stats

            types.forEach(type => {
                const sentStats = getStats('sent', type);
                const outstandingStats = getStats('outstanding', type);

                container.innerHTML += `
                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                        <p class="text-sm font-bold text-gray-700">TIPE ${type}</p>
                        
                        <p class="text-xs text-gray-500 mt-2">Rata-rata Terkirim</p>
                        <p class="text-xl font-semibold text-blue-600">${sentStats.avg.toFixed(0)}</p>

                        <p class="text-xs text-gray-500 mt-2">Rata-rata Belum Kembali</p>
                        <p class="text-xl font-semibold">${outstandingStats.avg.toFixed(0)}</p>
                        
                        <p class="text-xs text-gray-500 mt-1">Maksimum Belum Kembali</p>
                        <p class="text-lg font-semibold text-red-600">${outstandingStats.max.toFixed(0)}</p>
                    </div>
                `;
            });
        }
        
        function createOrUpdateChart(canvasId, instanceVar, label, data) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const histogramData = generateHistogramData(data);
            
            if (window[instanceVar]) window[instanceVar].destroy();

            window[instanceVar] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: histogramData.labels,
                    datasets: [{
                        label: label,
                        data: histogramData.counts,
                        backgroundColor: 'rgba(79, 70, 229, 0.8)',
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Frekuensi Skenario' }}, x: { title: { display: true, text: 'Jumlah Box' }} },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        function generateHistogramData(data) {
            const counts = {};
            data.forEach(x => { counts[x] = (counts[x] || 0) + 1; });
            const sortedLabels = Object.keys(counts).map(Number).sort((a, b) => a - b);
            const sortedCounts = sortedLabels.map(label => counts[label]);
            return { labels: sortedLabels, counts: sortedCounts };
        }
    </script>
</body>
</html>
